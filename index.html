<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RC SWEEPSTAKES</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Syncopate:wght@700&family=Inter:wght@400;900&display=swap" rel="stylesheet">
    <style>
        body { background-color: #050505; font-family: 'Inter', sans-serif; color: white; margin: 0; padding: 0; overflow-y: auto; }
        .heading { font-family: 'Syncopate', sans-serif; text-transform: uppercase; letter-spacing: -2px; }
        .money-grad { background: linear-gradient(135deg, #22c55e 0%, #fef08a 50%, #16a34a 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .glass { background: rgba(10, 10, 10, 0.9); backdrop-filter: blur(20px); border: 1px solid rgba(34, 197, 94, 0.2); }
        .btn-money { background: linear-gradient(180deg, #22c55e 0%, #14532d 100%); box-shadow: 0 0 30px rgba(34, 197, 94, 0.2); }
        .stamp-fx { transform: rotate(-15deg) scale(5); opacity: 0; }
    </style>
</head>
<body class="flex flex-col items-center justify-start min-h-screen p-4">

    <div id="app" class="w-full max-w-sm glass rounded-[2.5rem] p-6 flex flex-col items-center text-center relative overflow-hidden my-auto">
        <div class="absolute top-[-10%] left-[-10%] w-[120%] h-[30%] bg-green-500/10 blur-[80px] rounded-full"></div>

        <div class="z-10 mb-6">
            <h1 class="heading text-2xl font-black italic money-grad mb-1">RC</h1>
            <h2 class="text-[9px] tracking-[0.4em] text-zinc-500 uppercase font-bold">Sweepstakes</h2>
        </div>

        <div id="ui-home" class="w-full z-10">
            <div class="mb-6">
                <p class="text-[9px] text-zinc-500 uppercase tracking-widest mb-1">Live Jackpot Pool</p>
                <h3 class="heading text-5xl font-black mb-1" id="usd-pot">$0.00</h3>
                <p class="text-green-500 text-[10px] font-bold tracking-[0.2em] uppercase" id="sat-pot">0 SATS</p>
            </div>

            <div class="mb-6 bg-white/5 p-4 rounded-2xl border border-white/5">
                <p class="text-[9px] text-zinc-500 uppercase mb-1">Entry Fee</p>
                <p class="text-2xl font-black" id="usd-entry">$0.00</p>
                <p class="text-[9px] text-zinc-600 uppercase" id="sat-entry">1,000 SATS</p>
            </div>

            <input type="text" id="ln-address" placeholder="ENTER LIGHTNING ADDRESS" class="w-full bg-white/5 border border-white/10 rounded-xl p-4 mb-4 text-center text-[11px] font-bold tracking-widest uppercase focus:outline-none focus:border-green-500/50 text-white">

            <button onclick="buyTicket()" id="buy-btn" class="btn-money w-full py-5 rounded-2xl text-black font-black text-lg uppercase tracking-tighter transition-transform active:scale-95">Get Ticket</button>
            <p class="text-[8px] text-zinc-700 mt-6 tracking-widest uppercase" onclick="adminDraw()">Admin: Trigger Draw</p>
        </div>

        <div id="ui-payment" class="hidden w-full z-10 flex flex-col items-center">
            <p class="text-green-500 font-black text-xs mb-4 animate-pulse uppercase">Invoice Ready</p>
            <a id="wallet-link" href="#" class="w-full bg-white text-black font-black py-4 rounded-xl mb-3 flex items-center justify-center space-x-2 shadow-xl">
                <span>OPEN IN WALLET</span>
            </a>
            <button onclick="copyInvoice()" class="w-full bg-zinc-800 text-white text-[10px] py-3 rounded-lg mb-4 border border-white/10 tracking-widest uppercase">
                Copy Invoice Code
            </button>
            <div class="bg-white p-2 rounded-xl inline-block mb-4 shadow-2xl">
                <img id="qr-code" src="" class="w-32 h-32">
            </div>
            <p class="text-[8px] text-zinc-600 uppercase tracking-widest">Scan or Pay with Wallet</p>
        </div>

        <!-- Success/Draw/Result screens stay the same -->
        <div id="ui-success" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/95">
            <div id="stamp" class="stamp-fx text-green-500 font-black text-7xl border-8 border-green-500 p-4 rounded-xl italic">PAID</div>
        </div>
        <div id="ui-draw" class="hidden fixed inset-0 z-50 flex flex-col items-center justify-center bg-black">
            <h2 class="heading text-zinc-600 text-xl mb-10">Shuffling Entries</h2>
            <div id="slot-machine" class="text-7xl font-black heading money-grad italic">$----</div>
            <div class="w-48 h-1 bg-zinc-900 mt-4 rounded-full overflow-hidden">
                <div id="draw-progress" class="w-0 h-full bg-green-500"></div>
            </div>
        </div>
        <div id="ui-result" class="hidden fixed inset-0 z-50 flex flex-col items-center justify-center bg-black text-center p-10">
            <div id="res-icon" class="text-8xl mb-6">üèÜ</div>
            <h1 id="res-title" class="heading text-5xl font-black mb-4 italic"></h1>
            <button onclick="location.reload()" class="border border-green-500/30 text-green-500 px-10 py-4 rounded-full text-[10px] uppercase tracking-widest font-bold">Close Room</button>
        </div>
    </div>

    <script>
        const API_KEY = "ea5274aebdc043ffb8c9af5cdeefb379";
        const LNBITS_URL = "https://may-applicable-rounds-sbjct.trycloudflare.com";
        const ENTRY_SATS = 1000;
        const POT_SATS = 25000;

        let currentInvoice = "";
        let btcPrice = 0;

        async function updatePrice() {
            try {
                const res = await fetch('https://api.blockchain.info/ticker');
                const data = await res.json();
                btcPrice = data.USD.last;
                renderValues();
            } catch(e) { console.log("Price feed error"); }
        }

        function renderValues() {
            if (btcPrice === 0) return;
            const entryUsd = (ENTRY_SATS * btcPrice / 100000000).toFixed(2);
            const potUsd = (POT_SATS * btcPrice / 100000000).toFixed(2);
            document.getElementById('usd-entry').innerText = `$${entryUsd}`;
            document.getElementById('usd-pot').innerText = `$${potUsd}`;
            document.getElementById('sat-pot').innerText = `${POT_SATS.toLocaleString()} SATS`;
        }

        async function buyTicket() {
            const addr = document.getElementById("ln-address").value;
            if(!addr) { alert("Enter an address first!"); return; }
            document.getElementById('buy-btn').innerText = "AUTHORIZING...";
            try {
                const res = await fetch(`${LNBITS_URL}/api/v1/payments`, {
                    method: 'POST',
                    headers: { 'X-Api-Key': API_KEY, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ out: false, amount: ENTRY_SATS, memo: "ENTRY:" + addr })
                });
                const data = await res.json();
                currentInvoice = data.payment_request;
                document.getElementById('ui-home').classList.add('hidden');
                document.getElementById('ui-payment').classList.remove('hidden');
                document.getElementById('wallet-link').href = `lightning:${currentInvoice}`;
                document.getElementById('qr-code').src = `https://api.qrserver.com/v1/create-qr-code/?size=400x400&data=${currentInvoice}`;
                poll(data.payment_hash);
            } catch(e) {
                alert("Connection Error. Ensure your Cloudflare tunnel is running and you've clicked 'Visit Site' on its URL.");
                document.getElementById('buy-btn').innerText = "Get Ticket";
            }
        }

        function copyInvoice() {
            navigator.clipboard.writeText(currentInvoice);
            alert("Invoice Copied!");
        }

        async function poll(hash) {
            const check = setInterval(async () => {
                try {
                    const res = await fetch(`${LNBITS_URL}/api/v1/payments/${hash}`, {
                        headers: { 'X-Api-Key': API_KEY }
                    });
                    const status = await res.json();
                    if (status.paid) {
                        clearInterval(check);
                        showSuccess();
                    }
                } catch(e) { console.log("Polling..."); }
            }, 2000);
        }

        function showSuccess() {
            document.getElementById('ui-payment').classList.add('hidden');
            document.getElementById('ui-success').classList.remove('hidden');
            gsap.to("#stamp", { scale: 1, opacity: 1, duration: 0.4, ease: "bounce.out", onComplete: () => {
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#22c55e', '#ffffff'] });
                setTimeout(() => { location.reload(); }, 3000);
            }});
        }

        function adminDraw() {
            document.getElementById('ui-home').classList.add('hidden');
            document.getElementById('ui-draw').classList.remove('hidden');
            gsap.to("#draw-progress", { width: "100%", duration: 5, ease: "none" });
            let count = 0;
            const shuffle = setInterval(() => {
                document.getElementById('slot-machine').innerText = "$" + (Math.random() * 100).toFixed(2);
                count++;
                if (count > 80) {
                    clearInterval(shuffle);
                    const win = Math.random() > 0.5;
                    showResult(win);
                }
            }, 50);
        }

        function showResult(win) {
            document.getElementById('ui-draw').classList.add('hidden');
            document.getElementById('ui-result').classList.remove('hidden');
            const title = document.getElementById('res-title');
            if (win) {
                title.innerText = "WINNER";
                title.className = "heading text-6xl font-black italic money-grad mb-4";
                confetti({ particleCount: 400, spread: 120, origin: { y: 0.3 } });
            } else {
                title.innerText = "LOSS";
                title.className = "heading text-6xl font-black italic text-zinc-800 mb-4";
            }
        }
        updatePrice();
        setInterval(updatePrice, 30000);
    </script>
</body>
</html>
